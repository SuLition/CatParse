# Tauri 2.x 在线更新功能实现方案

本文档详细介绍了 BiliTools 项目中基于 Tauri 2.x 的在线更新功能实现方案，可作为其他项目的参考。

## 目录

- [技术架构概览](#技术架构概览)
- [后端配置（Rust）](#后端配置rust)
- [前端配置（Vue/TypeScript）](#前端配置vuetypescript)
- [更新服务器配置](#更新服务器配置)
- [密钥生成](#密钥生成)
- [CI/CD 集成](#cicd-集成)
- [完整代码示例](#完整代码示例)

---

## 技术架构概览

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   前端 (Vue)    │────▶│  Tauri Runtime   │────▶│  更新服务器     │
│  Updater.vue    │     │  updater plugin  │     │  latest.json    │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

### 核心依赖

| 组件 | 版本 | 说明 |
|------|------|------|
| `tauri` | 2.9.x | Tauri 核心框架 |
| `tauri-plugin-updater` | 2.9.0 | Rust 端更新插件 |
| `@tauri-apps/plugin-updater` | ^2.9.0 | 前端 JS 绑定 |
| `@tauri-apps/plugin-process` | ^2.3.1 | 用于重启应用 |

---

## 后端配置（Rust）

### 1. Cargo.toml 依赖配置

```toml
[dependencies]
tauri = { version = "2.9.5", features = ["macos-private-api"] }
tauri-plugin-process = "2.3.1"

# 仅在桌面平台启用更新插件（排除移动端）
[target.'cfg(not(any(target_os = "android", target_os = "ios")))'.dependencies]
tauri-plugin-updater = "2.9.0"
```

### 2. 注册更新插件 (lib.rs)

```rust
use tauri::Manager;

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() -> Result<(), Box<dyn std::error::Error>> {
    tauri::Builder::default()
        // 注册更新插件
        .plugin(tauri_plugin_updater::Builder::new().build())
        // 注册 process 插件（用于 relaunch）
        .plugin(tauri_plugin_process::init())
        // ... 其他插件和配置
        .run(tauri::generate_context!())
        .expect("error while running application");
    Ok(())
}
```

### 3. tauri.conf.json 配置

```json
{
  "$schema": "https://schema.tauri.app/config/2",
  "productName": "YourAppName",
  "version": "1.0.0",
  "identifier": "com.yourcompany.yourapp",
  "bundle": {
    "active": true,
    "createUpdaterArtifacts": true
  },
  "plugins": {
    "updater": {
      "active": true,
      "dialog": false,
      "pubkey": "你的公钥（Base64编码）",
      "endpoints": [
        "https://your-api.com/v1/latest/yourapp",
        "https://github.com/yourname/yourapp/releases/latest/download/latest.json"
      ]
    }
  }
}
```

**配置说明：**

| 字段 | 说明 |
|------|------|
| `createUpdaterArtifacts` | 构建时自动生成签名的更新包 |
| `active` | 是否启用更新功能 |
| `dialog` | 是否使用内置对话框（false 表示自定义 UI）|
| `pubkey` | minisign 公钥，用于验证更新包签名 |
| `endpoints` | 更新信息 JSON 的获取地址（支持多个备用地址）|

---

## 前端配置（Vue/TypeScript）

### 1. package.json 依赖

```json
{
  "dependencies": {
    "@tauri-apps/plugin-updater": "^2.9.0",
    "@tauri-apps/plugin-process": "^2.3.1",
    "@tauri-apps/plugin-log": "^2.7.1",
    "@tauri-apps/plugin-opener": "^2.5.2"
  }
}
```

### 2. 更新组件完整实现 (Updater.vue)

```vue
<template>
  <Transition name="slide">
    <div v-if="active && v.update" class="updater-overlay">
      <!-- 标题区域 -->
      <h1 class="title">
        <i class="fa-solid fa-sparkles"></i>
        <span>发现新版本！</span>
      </h1>
      
      <div class="content">
        <!-- 版本信息 -->
        <h2 class="version-info">
          <span @click="openUrl('https://github.com/yourname/yourapp/releases/tag/v' + v.update.version)">
            YourApp <a>v{{ v.update.version }}</a>
          </span>
          <div v-if="v.update.date" class="date">
            <i class="fa-solid fa-clock"></i>
            <span>{{ new Date(v.update.date).toLocaleString() }}</span>
          </div>
        </h2>
        
        <!-- 更新说明提示 -->
        <span class="hint">可在 "设置 → 常规" 中禁用 "自动检查更新"</span>
        
        <!-- 更新日志（Markdown 渲染） -->
        <vue-markdown 
          class="changelog"
          :source="v.update.body ?? ''"
          @click="handleLinkClick"
        />
        
        <!-- 操作按钮区域 -->
        <div class="actions">
          <button class="primary" @click="update">
            <i class="fa-solid fa-circle-down"></i>
            <span>下载并安装</span>
          </button>
          <button @click="close">跳过本次更新</button>
          
          <!-- 下载进度 -->
          <Transition name="slide">
            <div v-if="v.downloading" class="progress-container">
              <ProgressBar :progress="v.progress" />
              <span>{{ v.progress.toFixed(2) }}%</span>
            </div>
          </Transition>
        </div>
      </div>
    </div>
  </Transition>
</template>

<script lang="ts" setup>
import { markRaw, reactive, ref, watch } from 'vue';
import { useSettingsStore } from '@/store';
import { relaunch } from '@tauri-apps/plugin-process';
import { openUrl } from '@tauri-apps/plugin-opener';
import { info } from '@tauri-apps/plugin-log';

import * as updater from '@tauri-apps/plugin-updater';
import VueMarkdown from 'vue-markdown-render';
import ProgressBar from './ProgressBar.vue';

const active = ref(false);

// 暴露方法供外部调用
defineExpose({ check, close, active });

// 响应式状态
const v = reactive({
  update: null as updater.Update | null,
  downloading: false,
  progress: 0,
});

// 监听自动检查更新设置变化
watch(() => useSettingsStore().auto_check_update, check);

/**
 * 检查更新
 * @param notice 是否在没有更新时显示提示
 */
async function check(notice?: boolean) {
  // 支持代理设置
  const proxy = useSettingsStore().proxyUrl;
  const update = await updater.check({ ...(proxy && { proxy }) });
  
  console.log('Update:', update);
  info('Update: ' + JSON.stringify(update, null, 2));
  
  if (update) {
    // 使用 markRaw 避免响应式追踪大对象
    v.update = markRaw(update);
    // 隐藏当前页面，显示更新界面
    document.querySelector('.page')?.classList.add('hide');
    active.value = true;
  } else if (notice) {
    // 手动检查时，无更新也提示用户
    showMessage('已是最新版本', 'success');
  }
}

/**
 * 关闭更新界面
 */
function close() {
  active.value = false;
  document.querySelector('.page')?.classList.remove('hide');
}

/**
 * 处理 Markdown 中的链接点击
 */
function handleLinkClick(event: Event) {
  event.preventDefault();
  const a = (event.target as HTMLElement)?.closest('a');
  if (a) openUrl(a.href);
}

/**
 * 执行更新
 */
async function update() {
  let contentLength = 0;
  let downloadedChunk = 0;
  
  v.downloading = true;
  
  // 下载并安装，带进度回调
  await v.update?.downloadAndInstall((event) => {
    switch (event.event) {
      case 'Started': {
        // 获取总大小
        contentLength = event.data.contentLength ?? 0;
        break;
      }
      case 'Progress': {
        // 累计已下载大小，计算百分比
        downloadedChunk += event.data.chunkLength;
        v.progress = (downloadedChunk / contentLength || 0) * 100;
        break;
      }
    }
  });
  
  // 下载完成后重启应用
  await relaunch();
}
</script>
```

### 3. 进度条组件 (ProgressBar.vue)

```vue
<template>
  <div
    class="progress-bar"
    :style="{ '--progress': progress + '%' }"
  ></div>
</template>

<script lang="ts" setup>
defineProps<{
  progress: number;
}>();
</script>

<style scoped>
.progress-bar {
  position: relative;
  flex: 1;
  border-radius: 9999px;
  background: var(--button-color);
  height: 6px;
  width: 256px;
  margin: 0 8px;
}

.progress-bar::after {
  content: '';
  position: absolute;
  width: var(--progress);
  height: 100%;
  border-radius: 9999px;
  background: var(--primary-color);
  transition: width 0.2s;
}
</style>
```

### 4. 设置项 - 自动检查更新开关

```vue
<template>
  <section>
    <h3>
      <i class="fa-solid fa-up-from-line"></i>
      <span>自动检查更新</span>
    </h3>
    <Switch v-model="settings.auto_check_update" />
  </section>
</template>

<script lang="ts" setup>
import { useSettingsStore } from '@/store';
import { Switch } from '@/components';

const settings = useSettingsStore();
</script>
```

### 5. 手动触发检查更新（关于页面）

```vue
<template>
  <button class="primary" @click="components.c.updater?.check(true)">
    <i class="fa-solid fa-clock-rotate-left"></i>
    <span>检查更新</span>
  </button>
</template>

<script lang="ts" setup>
import { useComponentsStore } from '@/store';
const components = useComponentsStore();
</script>
```

### 6. 全局组件注册（组件管理器）

```typescript
// store/components.ts
import { Updater } from '@/components';

export const componentMap = {
  updater: Updater,
  // ... 其他全局组件
} as const;
```

```vue
<!-- ComponentsWrapper.vue -->
<template>
  <Teleport to="#main" defer>
    <component
      :is="Comp"
      v-for="(Comp, key) in componentMap"
      :key="key"
      :ref="(el) => store.regComponent(key, shallowRef(el as any))"
    />
  </Teleport>
</template>

<script lang="ts" setup>
import { useComponentsStore, componentMap } from '@/store/components';
import { shallowRef } from 'vue';

const store = useComponentsStore();
</script>
```

---

## 更新服务器配置

### latest.json 格式

更新服务器需要提供 `latest.json` 文件，格式如下：

```json
{
  "version": "1.4.7",
  "notes": "## 更新内容\n\n- 新功能 A\n- 修复 Bug B\n- 优化性能",
  "pub_date": "2025-01-06T12:00:00Z",
  "platforms": {
    "windows-x86_64": {
      "signature": "签名内容（.sig 文件内容）",
      "url": "https://github.com/yourname/yourapp/releases/download/v1.4.7/YourApp_1.4.7_x64-setup.nsis.zip"
    },
    "darwin-x86_64": {
      "signature": "签名内容",
      "url": "https://github.com/yourname/yourapp/releases/download/v1.4.7/YourApp_1.4.7_x64.app.tar.gz"
    },
    "darwin-aarch64": {
      "signature": "签名内容",
      "url": "https://github.com/yourname/yourapp/releases/download/v1.4.7/YourApp_1.4.7_aarch64.app.tar.gz"
    },
    "linux-x86_64": {
      "signature": "签名内容",
      "url": "https://github.com/yourname/yourapp/releases/download/v1.4.7/YourApp_1.4.7_amd64.AppImage.tar.gz"
    }
  }
}
```

### 平台标识符

| 平台 | 标识符 |
|------|--------|
| Windows x64 | `windows-x86_64` |
| macOS Intel | `darwin-x86_64` |
| macOS Apple Silicon | `darwin-aarch64` |
| Linux x64 | `linux-x86_64` |

---

## 密钥生成

### 使用 Tauri CLI 生成密钥对

```bash
# 安装 Tauri CLI
cargo install tauri-cli

# 生成密钥对
cargo tauri signer generate -w ~/.tauri/myapp.key
```

生成后会输出：
- **私钥文件**: `~/.tauri/myapp.key` (用于签名，保密)
- **公钥**: 直接输出到控制台 (配置到 `tauri.conf.json` 的 `pubkey` 字段)

### 环境变量配置（CI/CD 使用）

```bash
# 私钥内容
TAURI_SIGNING_PRIVATE_KEY="私钥内容"

# 私钥密码（如果设置了的话）
TAURI_SIGNING_PRIVATE_KEY_PASSWORD="your-password"
```

---

## CI/CD 集成

### GitHub Actions 示例

```yaml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu

    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'v__VERSION__'
          releaseBody: 'See the release notes for details.'
          releaseDraft: false
          prerelease: false
```

### 构建产物

启用 `createUpdaterArtifacts: true` 后，构建时会自动生成：

| 平台 | 更新包 | 签名文件 |
|------|--------|----------|
| Windows | `*.nsis.zip` | `*.nsis.zip.sig` |
| macOS | `*.app.tar.gz` | `*.app.tar.gz.sig` |
| Linux | `*.AppImage.tar.gz` | `*.AppImage.tar.gz.sig` |

---

## 完整代码示例

### 设置 Store (settings.ts)

```typescript
import { defineStore } from 'pinia';
import { reactive, computed, toRefs } from 'vue';

export const useSettingsStore = defineStore('settings', () => {
  const s = reactive({
    auto_check_update: false,  // 默认关闭，启用后触发 watch
    check_update: true,
    proxy: {
      address: '',
      username: '',
      password: '',
    },
    // ... 其他设置
  });

  // 计算代理 URL
  const proxyUrl = computed(() => {
    if (!s.proxy.address.length) return null;
    const url = new URL(s.proxy.address);
    url.username = s.proxy.username || '';
    url.password = s.proxy.password || '';
    return url.toString();
  });

  return { ...toRefs(s), proxyUrl };
});
```

### 国际化配置 (zh-CN.json)

```json
{
  "updater": {
    "title": "发现新版本！",
    "latest": "已是最新版本",
    "hint": "可在 \"设置 → 常规\" 中禁用 \"自动检查更新\"，但不建议这么做",
    "install": "下载并安装",
    "cancel": "跳过本次更新"
  },
  "settings": {
    "auto_check_update": {
      "name": "自动检查更新"
    }
  },
  "info": {
    "checkUpdate": "检查更新"
  },
  "error": {
    "checkUpdate": "请在 GitHub 检查最新更新"
  }
}
```

---

## 注意事项

1. **签名验证**: 更新插件会自动验证下载包的签名，确保安全性
2. **代理支持**: 可通过 `check({ proxy: 'http://...' })` 传入代理配置
3. **多端点备用**: 配置多个 endpoints 时，会依次尝试直到成功
4. **版本比较**: 插件自动基于语义化版本比较，仅当服务器版本更高时触发更新
5. **移动端排除**: 更新插件仅在桌面平台可用，需在 Cargo.toml 中使用条件编译
6. **错误处理**: 建议在 `check()` 和 `downloadAndInstall()` 外包裹 try-catch

---

## 参考链接

- [Tauri Updater Plugin 官方文档](https://tauri.app/plugin/updater/)
- [tauri-plugin-updater GitHub](https://github.com/tauri-apps/plugins-workspace/tree/v2/plugins/updater)
- [Tauri Signing 文档](https://tauri.app/distribute/sign-windows/)
